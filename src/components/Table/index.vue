/* * 列表查询组件 */
<template>
  <div class="table-form-container_content">
    <!-- form表单 -->
    <div class="table-header" :style="{
        justifyContent:
          tableSearch && tableSearch.length > 0 ? 'space-between' : 'flex-end',
      }">
      <el-form v-if="tableSearch && tableSearch.length > 0" size="small" :rules="rules" :model="formSearch" :inline="true" ref="formSearch" label-position="right" v-bind="{ 'label-width': '110px', ...(options && options.formProps) }">
        <el-form-item :key="index" :prop="item.value" class="table-header-item" :label="item.label + '：'" v-bind="item.labelProps" v-for="(item, index) in tableSearch">
          <el-select clearable v-bind="item.props" v-if="item.type === 'select'" v-model="formSearch[item.value]" :placeholder="`请选择${item.placeholder || item.label}`">
            <el-option v-for="option in item.children" :key="option.value" :value="option.value" :label="option.label" />
          </el-select>
          <el-date-picker clearable style="width: 100%" placeholder="选择日期" v-model="formSearch[item.value]" v-else-if="item.type === 'picker'" v-bind="item.props || { type: 'date' }" />
          <el-cascader clearable v-bind="item.props" :options="item.options" v-model="formSearch[item.value]" v-else-if="item.type === 'cascader'" :placeholder="`请输入${item.placeholder || item.label}`"></el-cascader>
          <el-input v-else clearable v-bind="item.props" :type="item.inputType || 'text'" v-model="formSearch[item.value]" :placeholder="`请输入${item.placeholder || item.label}`" :maxlength="item.maxlength" @keyup.enter.native="handleSearch" :oninput="handleChangeInput(item)" />
        </el-form-item>
        <el-form-item>
          <el-button size="small" type="primary" icon="el-icon-search" @click="handleSearch">查询</el-button>
          <el-button plain size="small" icon="el-icon-refresh-right" @click="handleReset('formSearch')">重置</el-button>
        </el-form-item>
      </el-form>
      <div v-if="isAdd" @click="$emit('addData')">
        <el-button size="small" icon="el-icon-plus" type="primary">新增</el-button>
      </div>
    </div>

    <!-- 扩展性内容 -->
    <slot name="content_context"></slot>

    <!-- table中间button eg:导出 -->
    <div v-if="exportBut && exportBut.length > 0" class="btn-operates">
      <a :key="index" :href="item.href || null" v-for="(item, index) in exportBut" @click="item.method()">
        <el-button size="small" type="primary">{{ item.title }}</el-button>
      </a>
    </div>

    <!-- table表格 -->
    <el-table size="small" :border="border" style="width: 100%" :data="dataApi ? DATA_SOURCE : dataSource" v-loading="dataApi ? LOADING : loading" v-bind="options" v-on="tableEvents" row-key="id" :tree-props="treeProps" ref="multipleTable" @selection-change="handleSelectionChange">
      <!-- 复选框 -->
      <el-table-column type="selection" style="width: 55px" v-if="
          options && options.selection && (!options.isShow || options.isShow())
        " />
      <!-- 序号 -->
      <el-table-column width="60" align="center" type="index" v-if="options && options.index" :label="options && options.labelIndex" />

      <!-- 表格数据 -->
      <template v-for="(column, index) in columns">
        <el-table-column :key="index" v-bind="column.props" :prop="column.prop" :label="column.label" :align="column.align" :fixed="column.fixed" :width="column.width" :show-overflow-tooltip="column.showTooltip" v-if="!column.isShow || (column.isShow && column.isShow())">
          <template slot-scope="scope">
            <template v-if="!column.render">
              <template v-if="column.formatter">
                <span v-html="column.formatter(scope.row, column, scope.$index)" @click="column.click && column.click(scope.row, scope.$index)"></span>
              </template>
              <template v-else-if="column.newjump">
                <router-link class="newjump" type="primary" :underline="false" v-bind="{ target: '_blank', ...column.target }" :to="column.newjump(scope.row, column, scope.$index)">{{ scope.row[column.prop] || column.content }}</router-link>
              </template>
              <template v-else>
                <span :style="
                    column.click ? 'color: #409EFF; cursor: pointer;' : null
                  " @click="column.click && column.click(scope.row, scope.$index)">
                  {{ scope.row[column.prop] || column.content }}
                  {{
                    `${
                      scope.row[column.prop] && column.unit ? column.unit : ""
                    }`
                  }}
                </span>
              </template>
            </template>
            <template v-else>
              <render :column="column" :row="scope.row" :render="column.render" :index="scope.$index"></render>
            </template>
          </template>
        </el-table-column>
      </template>

      <!-- slot插槽按钮 -->
      <el-table-column label="操作" align="center" v-if="options && options.slotcontent">
        <template slot-scope="scope">
          <slot :data="scope"></slot>
        </template>
      </el-table-column>

      <!-- 操作按钮-按钮 -->
      <el-table-column label="操作" align="center" fixed="right" :width="dropdownOption ? '100px' : '180px'" v-bind="options && options.props" v-if="operates && operates.length > 0">
        <template slot-scope="scope">
          <div class="operate-group">
            <template v-if="dropdownOption">
              <el-dropdown>
                <el-button type="primary" size="small">
                  操作<i class="el-icon-arrow-down el-icon--right"></i>
                </el-button>
                <el-dropdown-menu slot="dropdown">
                  <el-dropdown-item v-for="(btn, key) in operates" :key="key" v-bind="btn.props" @click.native.prevent="btn.method(scope.row, scope.$index)" :disabled="
                      btn.disabled && btn.disabled(scope.row, scope.$index)
                    ">{{
                      btn.changeLabel &&
                      btn.changeLabel(scope.row, scope.$index)
                        ? btn.changeLabel(scope.row, scope.$index)
                        : btn.label
                    }}</el-dropdown-item>
                </el-dropdown-menu>
              </el-dropdown>
            </template>
            <template v-if="!dropdownOption">
              <template v-for="(btn, key) in operates">
                <span :key="key" v-if="
                    !btn.isShow ||
                    (btn.isShow && btn.isShow(scope.row, scope.$index))
                  ">
                  <template v-if="btn.render">
                    <render :column="scope.row" :row="scope.row" :render="btn.render" :index="scope.$index"></render>
                  </template>
                  <template v-if="!btn.render">
                    <el-button :size="btn.size || 'small'" :type="btn.type || `text`" :icon="btn.icon" :plain="btn.plain" :style="btn.setStyle" v-bind="btn.props" @click.native.prevent="
                        btn.method(scope.row, scope.$index)
                      " :disabled="
                        btn.disabled && btn.disabled(scope.row, scope.$index)
                      ">
                      {{ btn.label
                      }}{{ operates.length >= 2 ? "&nbsp;&nbsp;" : "" }}
                    </el-button>
                  </template>
                </span>
              </template>
            </template>
          </div>
        </template>
      </el-table-column>
    </el-table>
    <br />
    <!-- 分页部分 -->
    <el-pagination background class="pagination" v-if="pagination" :total="dataApi ? DATA_TOTAL : dataTotal" :page-size="pagination.pageSize" @current-change="handleChangePage" v-bind="options && options.pageExtend" :current-page.sync="currentPage" :layout="
        options && options.pageExtend && options.pageExtend.layout
          ? options.pageExtend.layout
          : 'prev, pager, next, jumper'
      " v-on="options && options.handlePageEvent" />
  </div>
</template>

<script>
import { convertParams } from "./utils";

const methods = {
  // 复选框选中项
  handleSelectionChange(val, index) {
    this.multipleSelection = val;
    this.$emit("handleSelectionChange", Array.from(val));
  },

  // 改变分页触发事件
  handleChangePage(val) {
    this.currentPage = val;
    /***   分页请求接口有两种情况  判断是否有dataApi 有dataApi 在table中请求数据 否则通过传递方法到页面请求数据  ***/
    if (this.dataApi) {
      this.handleGetList(this.pageNum, this.pageSize, this.formSearch, {
        pageNum: val,
      });
      return;
    }

    this.$emit("handleChangePage", val);
  },

  // 搜索查询按钮
  handleSearch() {
    this.currentPage = 1; //搜索数据时将页码设置为第一页

    /* 如果有dataApi 在组件内请求数据 */
    if (this.dataApi) {
      this.handleGetList(1, 10, this.formSearch);
      return;
    }
    /* 是否需要校验规则 */
    if (this.rules) {
      return this.$refs["formSearch"].validate((valid) => {
        if (!valid) return false;
        this.$emit(
          "handleSearch",
          convertParams(Object.assign({}, this.formSearch))
        );
      });
    }

    this.$emit(
      "handleSearch",
      convertParams(Object.assign({}, this.formSearch))
    );
  },

  // 搜索重置按钮
  handleReset(formName) {
    this.$refs[formName].resetFields();
    this.formSearch = this.reset ? { ...this.value } : {};
    this.$emit("handleReset");
    if (this.reset) return false;
    this.handleSearch();
  },

  // input为number校验
  handleChangeInput(item) {
    return item.inputType === "number"
      ? this.handleOnInput(
          this.formSearch[item.value],
          item.value,
          item.rulesLength
        )
      : null;
  },

  // input渲染长度校验
  handleOnInput(val, label, rulesLength, maxlength = 11) {
    if (val && Number(val) <= 0) {
      this.formSearch[label] = 0;
    }
    if (rulesLength && val && val.length > maxlength) {
      this.formSearch[label] = this.formSearch[label].slice(0, maxlength);
    }
  },

  /**
   * @name: 获取列表数据
   * @param {*} @pageNum 请求的页面 @pageSize 请求的页面数据条数 @changeVal 改变页数的数据
   * @return {*}
   */
  handleGetList(pageNum = 1, pageSize = 10, query = {}, changeVal = {}) {
    /* 带请求参数 */
    if (this.params && this.dataApi) query = { ...this.params, ...query };
    if (this.LOADING) return;
    this.LOADING = true;
    let params = { ...{ pageNum, pageSize, query }, ...changeVal };
    this.dataApi(params)
      .then((res) => {
        this.DATA_SOURCE = res.content;
        this.DATA_TOTAL = res.total;
        this.LOADING = false;
      })
      .catch((e) => {
        console.log(e);
        this.LOADING = false;
      });
  },
};

export default {
  name: "Table",
  props: {
    tableSearch: {
      type: Array,
      default: () => [],
    },
    rules: {
      type: Object,
    },
    value: {
      type: Object,
    },
    reset: {
      type: Boolean,
    },
    dataSource: {
      type: Array,
      default: () => [],
    },
    columns: {
      type: Array,
      default: [],
    },
    border: {
      type: Boolean,
      default: false,
    },
    loading: {
      type: Boolean,
      default: false,
    },
    slotcontent: {
      type: Boolean,
      default: false,
    },
    operates: {
      type: Array,
    },
    pagination: {
      type: Object,
      default: () => {
        return {
          pageSize: 10,
          currentPage: 1,
        };
      },
    },
    dataTotal: {
      type: Number,
      default: 0,
    },
    exportBut: {
      type: Array,
    },
    isAdd: {
      type: Boolean,
    },
    treeProps: {
      type: Object,
    },
    fixed: {
      type: String,
    },
    options: Object,
    tableEvents: Object,
    /* 是否是下拉操作按钮 */
    dropdownOption: {
      type: Boolean,
      default: false,
    },
    /* 请求数据由table请求 */
    dataApi: {
      type: Function,
    },
    refresh: {
      type: Number,
    },
    /* 请求参数 */
    params: {
      type: Object,
      default: () => {},
    },
    /* 禁选的商品 */
    // disabledGoods: {
    //   type: Array,
    // },
  },

  data() {
    return {
      currentPage: 1, //当前选中的page
      formSearch: {},
      multipleSelection: [],
      pageNum: 1,
      pageSize: 10,
      DATA_SOURCE: [], //table数据
      LOADING: false, //table 加载
      DATA_TOTAL: 0, //数据总条数
      REFRESH: 0,
    };
  },

  created() {
    /* 当传入了api才请求数据 */
    this.dataApi ? this.handleGetList(this.pageNum, this.pageSize) : "";
  },

  mounted() {
    this.formSearch = { ...this.value };
    this.$nextTick(() => {
      this.$emit("toggleRowSelection", this.$refs.multipleTable);
    });
  },

  methods,

  watch: {
    value(val) {
      if (val) return (this.formSearch = { ...this.value });
    },
    /* 数据刷新 */
    refresh(val) {
      if (this.REFRESH !== val) {
        this.REFRESH = val;
        this.handleGetList(this.currentPage, this.pageSize, this.formSearch);
      }
    },
  },

  components: {
    render: {
      functional: true,
      props: {
        row: Object,
        render: Function,
        index: Number,
        column: {
          type: Object,
          default: null,
        },
      },
      render: (h, opt) => {
        const params = {
          row: opt.props.row,
          index: opt.props.index,
        };
        if (opt.props.column) params.column = opt.props.column;
        return opt.props.render(h, params);
      },
    },
  },
};
</script>

<style lang="scss">
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
}
input[type="number"] {
  -moz-appearance: textfield;
}
</style>

<style lang="scss" scoped>
.table-form-container_content {
  overflow: hidden;
  .btn-operates {
    margin-bottom: 6px;
    a {
      color: #fff;
      text-decoration: none;
      display: inline-block;
    }
  }
}
.table-header {
  padding-top: 10px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  .table-header_button {
    text-align: right;
    float: right;
    margin-bottom: 12px;
    line-height: 40px;
  }
  .table-header-item .el-form-item {
    width: 100%;
    display: flex;
    flex: auto;
    margin-bottom: 12px;
    .el-form-item__content,
    .el-select {
      width: 100%;
    }
  }
}
.newjump {
  font-size: 12px;
  text-decoration: none;
  color: dodgerblue;
}

.pagination {
  text-align: right;
}
</style>